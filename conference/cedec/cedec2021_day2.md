
# カンファレンス「CEDEC2021 2日目」
- 20210824

## スペキュラーアンチエイリアシングを極める
- AMD
- 德吉
    - Temporal AA
        - ハイライトが遅延
        - サンプル数が不十分
        - NDFをプレフィルタリングして解決
            - マイクロファセットを荒くする
                - 面のマクロな起伏
    - ジオメトリックスペキュラーアンチエイリアシング
        - ハイライトのちらつき抑制
        - レンダリングの基礎が必要
        - オンザフライでフィルタリング
        - スペキュラーエイリアシングのみを低減
        - 高品質なtanフレームが必要
        - 編かの大きな曲面で荒さを増やす
        - 既存手法
            - 視線、光源の中間ベクトルの傾きの偏微分を利用
            - しかし、入射角が浅いと誤差が大きい
    - まとめ
        - 理解が難しい
            - ラフネス行列の行列式は何を意味するのか
        - 線形代数の実用的な近似
            - フィルターカーネルを小さいと仮定して近似
            - 中間ベクトルを法線を用いて近似

### NieR Re[in]carnationの安定リリースを支えたバックエンド開発ノウハウ
- 株式会社アプリボット
- 伊藤
    - DAU (Daily Active Users)
    - F2P (Free to play)
    - ツール
        - AWS
        - Kotlin
        - gRPC
        - Amazon Aurora
        - OCTO
            - アセット配信
        - Dive
            - データ分析
        - CEDEC2017, 18, 19に資料あり
        - 課金回りはSQUARE ENIX BRIDGE
        - ER Fluete
            - データ設計
            - 重い
            - 不要な機能が多い
            - XMLで差分がわかりづらい
            - plantUMLに移行
        - ER図のルール
            - テーブルやカラムが同一のものを操作するか
            - 記述方法に制約があり、逸脱が少ない
        - Kubernetes
            - OSSのコンテナ
        - 開発環境
            - Githubにアップされているものが正義

## BLUE PROTOCOLにおけるアニメ表現技法について　～実装編～
- バンダイナムコスタジオ
- 大井
    - デファードレンダリング
    - セルシェーディング
        - 2手法
            - Surfaceマテリアル
            - PostProcessマテリアル
    - ライティング
        - SpecularMask
            - 髪のハイライトの重心からの距離をマッピングして利用
        - NdotL, BaseColor, ShadowColorの組み合わせ
        - RimLightMask
            - リム（境界の光？）の入りやすさをマッピング
        - リムライト
            - ソーベルフィルタ
                - 微分してエッジ抽出
        - 顔に余計な輪郭が書かれないように対策
            - デプスで判定
        - 髪の眉部分を透かす
            - BasePassを分割
        - TemporalAAで輪郭線が溶ける問題の発生
            - ResponsiveAAで対処
                - ステンシルに書き込む
                - AAは弱いが動画ではさほど気にならない
    - 影
        - 背景用とキャラ用を使い分ける
        - オフセットシャドウ
            - 肌に服の影
            - デプスで判別
            - スクリーンスペースでずらして描画することで画面端で切れない？？
    - ポストプロセス
        - ディフュージョン

## モーションアクターによる、より質の高い人の動きを表現するためのノウハウ共有
- 株式会社モーションアクター
- 杉口
    - モーションだけでなく理屈も渡す
    - 加速
        - 脚が開いている方向には速い
            - 重心と踵の間に傾斜ができるため
            - ジャンプしてすぐ傾斜を作ると速い
                - ゲームでは見栄えが悪い？
        - 体幹がないと上半身が取り残される
            - 心理的な立場が低いキャラに起こりやすい
            - 後退でも同様
    - ジャンプ
        - 高揚感を生む
            - 滞空時間に相関あり
        - 支点と重心を結ぶ直線状に跳ぶ
            - 乗っかっているほど高く跳べる
        - 腕で身体を引っ張る
    - 切り返し
        - 反作用（ブロッキング・テイクバック）を利用
            - 造語
                - 対反射
                    - 加速させたサブ部位を急ブレーキ
                    - メイン部位に力を与える
                    - 例
                        - バレーのブロック
                        - 回し蹴りで上体を対反射させないとバレエになる
                - 対反発
                    - 動く方向と逆方向に引っ張る
                    - 例
                        - ボクシングの右ストレートでは左の腕が下がる
                            - 八極拳がよりわかりやすい
                        - 踵落としで下がる上体
                        - 斧の振り下ろしでパワーを出す際、上体は後ろに傾ける
    - インパクト
        - ブレないように身体を絞める
        - シルエット（決めポーズ）を意識
        - 骨が一直線になっているほど安定
            - 蹴りで腰を出さない
            - 斧やロープアクションで脇を占める
    - 着地
        - エロス
            - しなやかさ
            - 余韻
            - 外連味
        - 骨は一直線に
            - 高い所から着地するときほど腰は浅く落とすべき
                - ゲームでは好みが分かれる
            - 前に跳ぶときは支点を前に出しておく
                - 出さないと前のめりになる
                - スライディングではより前に出す
                    - 余裕感が出る
    - 応用
        - スムーズにする際は上記を同時に
        - ダイナミックにする際は上記をバラす
        - 例
            - ジャンプパンチ
                - 理論上、脚は前後に開く
                    - スムーズさに欠ける
                        - ジャンプと脚のテイクバックを同時にやると良い
                        - 着地とインパクトも同時にできることがある
                            - 大袈裟に演出する際はあえてバラす
            - 走りパンチ
                - 腕は、自動車事故で前に吹っ飛ぶ運転手をイメージ
            - 上半身が常に垂直な剣の達人
                - 見えないが対反発は起こっている
            - 大剣、パンチ
                - 振り下ろし後に身体が前に引っ張られる演出
    - 動きの言語化
        - 説明を繰り返せ
    - 縦の回転切りは2回ブロッキングが必要
        - トランポリンでは4つが限界

## 『New ポケモンスナップ』におけるライティング
- バンナム
- 多田、鈴木、山口、溝口
- CeDiL資料まとめ
    - 全ポケモンの色数・色相のバランスを考慮
    - GPU負荷を下げ、かつ質を上げるためには
        - ライティングの整合性が重要
            - 地面と看板の色など
        - ポストエフェクトではなく
    - 静的なライトベイクを活用
        - DirectX Raytracingを基に自作
    - 露出
        - カメラと同じEV値を採用
        - ライトでなく露出を調整
    - 自然のスカイライト
        - HDRIの太陽輝度を平行光源に変換
            - 太陽部分を一定値でクランプ
            - 変換不要なレンダラーもある
        - 法線照度の算出
            - 計測面を光源方向に向けた照度
            - パノラマ画像から
        - 向きと照度の算出
            - 光源のある画像とない画像
        - 太陽輝度はアーティファクトを生んでしまうアプリが多い
        - 曇天の下でキャラクリしない
        - 雲の厚さや雨雲かで日陰・日向のルクスのコントラストが異なる
        - バリエーションが乏しい
            - 時刻
            - 天候
            - 経度緯度
                - 地中海性気候とした
            - Terragenを検証しシミュレート
            - パノラマ画像から
            - 16bit float レンダーターゲット
        - 
    - トーン＆マナー
        - 背景
            - 版権キャラの情報量に合わせる
            - トーンカーブ
                - 白飛び
                    - 一部は画作りとして許容
                    - カメラのトーンカーブは現実と異なる
                - DaVinci Resolve
                - 高い輝度で彩度を保つようなカーブに
                - LUTにしてエディタへ
                - 無加工の良素材を作る
        - 測色
            - Nixpro2 
            - 蛍光色の計測で255になることも
                - 恐らく超えている
        - 明度
            - バウンスの影響を撮影で確認
            - 壁の色を調節
        - マテリアルの調整
            - 原因かマテリアルかライティングか分かりにくい
                - マテリアルの質を高める
                - ライティングプリセットで比較
        - LOOKDEV環境
            - 平行光源とHDRIのSHライトプローブのみ
            - モデルを様々な現実背景に設置して確認
                - PBR（フィジカルベースドレンダリング）
            - 現実のマテリアルはライティングを変えても自然
        - シェーダー
            - EVカウンター
                - レンジ外のEVは一定に
                - 発光物の見え方を昼夜で不変に
            - ライトプローブやライトまプの値から補正
            - リニアでなく、音量つまみのような対数補間
        - ライティング
            - 反射率やバウンス回数で固さが変わる
            - 環境光による支配色
                - 島ごとのテーマカラー
                    - アセットが出そろったタイミングで考慮
                - 工業的なランプで不足するため、植物を発光
                - FOGの色
            - 商業ライティング
            - 空の時間とEV値を決定
            - ライトプローブの配置と間隔の確認
                - 等間隔に球体を設置
                    - Uniform Grid
            - デバッグ写真はSlackへ
                - 不具合の時期がわかる
            - 現実世界の輝度値 * 1/1000の式で検証
            - カラーチェッカー
                - 色のパレット
                - 環境マップやライトプローブを確認する球体
                - 影を落とす板
            - 負荷軽減
                - 凹凸の多いモデルはSHライトマップ
                - 他はDiffuseライトマップ
            - ライトマップチェッカーボード
                - ライトマップのー解像度を確認
            - 空は別モデルでベイク
            - 影色
                - Terragenの空を編集してベイク
            - 昼を基に夜を作るとエミッシブのオブジェクトが悪目立ち
                - 商業施設のロケハン
                    - どこにどの強さで配置
                - ポケモンの見え方が第一
                    - 緑は元気に見えなくなるため注意
                - ホラー洞窟
                    - 近くで見ると複雑
                    - 離れてみると色相がわかる
                    - 奥に続くことがわかりやすいように
                - ベイク時のみ計算するメッシュライト
                    - 指向性も持たせる調節も
                - ベイク用のエミッシブマップ
                    - レイがヒットしやすいようになだらかなテクスチャ
                - 探し出す楽しみ、かつ寄ったときに可愛く
                    - 彩度の高いライトでキャラが認識しづらい
                        - グレースケール変換
                            - カラーと一定値の内積
                    - 近寄るとキャラクターに当たるライト
                        - ホーホーの目だけは遠めでも明るく
            - 質up
                - レフ板効果
                    - 太陽光だけでは暗部が発生するため
                - カウンターカラー
                    - 水色の反対の黄色を当てる
                - ナイトサファリ感
                    - プレイヤーライト
                        - 色味が単調
                        - ポケモンの目に悪い
                    - 周辺減光
            - 不具合
                - 壁に斑点
                    - レイが無限遠だったため
                - ベイクできない
                    - ライトマップ解像度が低かったため
                    - 自作ベイカーだｓ修ししやすい
                - ライトが反応しない
                    - 青すぎるとオレンジを当てても変化なし
                        - RGBのどれかを0にするのは危険
                    - 高彩度でRGB値が飽和？
                        - sRGBの色域が狭いと危険
                        - 高彩度を使わない手も
                - サムネイルの周辺減光が強く見える
                    - サムネイルの枠が明るいことによる錯覚
                    - サムネイルを明るくした
                - 自宅とオフィスの照明の違いで色味が変化
                    - オフィスの蛍光灯を抜いた
                    - 暗いシーをほど影響が強い
            - まとめ
                - チームの理解のための現実のリファレンス
                    - ネットの画像は加工されている
            - 付録
                - よく使うノードはSetter, Getterを用意し、BPを綺麗に
                - ポストプロセスボリューム
                    - EV値を変化させる領域
                - 滝などでレイを確率的に透過させる
                - 片面ポリゴンの木の葉を両面ポリゴン風にベイクし、木陰を落とす
                - レイを遮蔽する直方体
                - 半影
                    - 太陽周辺方向に複数のレイを飛ばした
                - 草などのレイ生成元のモデルを無視
                    - ライトマップの解像度が低く、複雑なモデル
                    - 解像度が低い影がベイクされてしまう
                - 濃すぎるスペキュラの不具合
                    - 環境マップに太陽が写り込み、二重でライティングしていた
                    - レンダーターゲットの明るさをクランプ
                - 現実の曇天ではAOがほぼ無い
    - 目的→手段の流れが正しい
